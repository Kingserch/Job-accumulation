+ ### Kubernetes
    + [环境准备](#环境准备)
    + [安装bind服务](#安装bind服务)
    + [配置证书](#配置证书)
    + [安装docker并搭建harbor](#安装docker)
    + [部署master节点服务](#部署master节点服务)
+ ### 环境准备
`yum install epel-release`   
`yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y`  
+ ### 安装bind服务
##### 1)在hdss7-129主机上安装bind服务(DNS服务)
```
[root@hdss7-129 ~]# yum install bind -y
[root@hdss7-129 ~]# rpm -qa bind
bind-9.11.4-16.P2.el7_8.2.x86_64
[root@hdss7-129 ~]# netstat   -rn   #查看网关
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         192.168.56.2    0.0.0.0         UG        0 0          0 ens33
172.7.68.0      0.0.0.0         255.255.255.0   U         0 0          0 docker0
192.168.56.0    0.0.0.0         255.255.255.0   U         0 0          0 ens33
[root@hdss7-129 ~]# vi /etc/named.conf
options {
        listen-on port 53 { 192.168.56.129; };	#默认是127.0.0.1本机需要改成本机的内网ip
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { any; };
        forwarders      { 0.0.0.0; };	#本机的网关
        recursion yes;	#一定要是yes 表示用递归的算法查询DNS，另一种是迭代
        dnssec-enable no;
        dnssec-validation no;
[root@hdss7-129 /]# named-checkconf	#检查
```
##### 2)在hdss7-129主机配置区域配置文件
```
[root@hdss7-129 /]# vim /etc/named.rfc1912.zones
...#在最后添加下面字段
zone "host.com" IN {
        type  master;
        file  "host.com.zone";
        allow-update { 192.168.56.129; };
};

zone "od.com" IN {
        type  master;
        file  "od.com.zone";
        allow-update { 192.168.56.129; };
};
```
##### 3)在hdss7-129主机编辑区域数据文件
```
[root@hdss7-129 /]# vim /var/named/host.com.zone
$ORIGIN host.com.
$TTL 600	; 10 minutes
@       IN SOA	dns.host.com. dnsadmin.host.com. (
				2020051101 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
			NS   dns.host.com.
$TTL 60	; 1 minute
dns                A    192.168.56.129
hdss7-11           A    192.168.56.129
hdss7-12           A    192.168.56.128
hdss7-21           A    192.168.56.130
hdss7-22           A    192.168.56.131
[root@hdss7-129 /]# vim /var/named/od.com.zone	业务域
$ORIGIN od.com.
$TTL 600	; 10 minutes
@   		IN SOA	dns.od.com. dnsadmin.od.com. (
				2020051101 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
				NS   dns.od.com.
$TTL 60	; 1 minute
dns                A    192.168.56.129
[root@hdss7-129 /]# named-checkconf		#检查更改的配置文件
[root@hdss7-129 /]# systemctl start named	
[root@hdss7-129 /]# netstat -luntp |grep 53 
tcp        0      0 192.168.56.129:53       0.0.0.0:*               LISTEN      18812/named         
tcp        0      0 127.0.0.1:953           0.0.0.0:*               LISTEN      18812/named         
tcp6       0      0 ::1:953                 :::*                    LISTEN      18812/named         
udp        0      0 192.168.56.129:53       0.0.0.0:*                           18812/named   
[root@hdss7-129 ~]# dig -t A hdss7-11.host.com @192.168.56.129 +short
192.168.56.129
[root@hdss7-129 ~]# dig -t A hdss7-12.host.com @192.168.56.129 +short
192.168.56.128
[root@hdss7-129 ~]# dig -t A hdss7-21.host.com @192.168.56.129 +short
192.168.56.130
[root@hdss7-129 ~]# dig -t A hdss7-22.host.com @192.168.56.129 +short
192.168.56.13
[root@hdss7-129 ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search localdomain
nameserver 192.168.56.2
nameserver 192.168.56.129
```
+ ### 配置证书
```
[root@hdss7-131 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
[root@hdss7-131 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
[root@hdss7-131 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
[root@hdss7-131 ~]# chmod +x /usr/bin/cfssl*
[root@hdss7-131 ~]# which cfssl
/usr/bin/cfssl
[root@hdss7-131 ~]# which cfssl-json
/usr/bin/cfssl-json
[root@hdss7-131 ~]# which cfssl-certinfo
/usr/bin/cfssl-certinfo
[root@hdss7-131 ~]# mkdir -p /opt/certs
[root@hdss7-131 ~]# cd /opt/certs/
[root@hdss7-131 certs]# pwd
/opt/certs
[root@hdss7-131 certs]# vi ca-csr.json
{
    "CN": "kingEdu",
    "hosts": [
    ],
    "key": {
        "algo": "rsa",	#rsa加密算法
        "size": 2048	#长度2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ],
    "ca": {
        "expiry": "175200h"		#证书过期时间
    }
}
[root@hdss7-131 certs]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca
2020/05/11 16:53:28 [INFO] generating a new CA key and certificate from CSR
2020/05/11 16:53:28 [INFO] generate received request
2020/05/11 16:53:28 [INFO] received CSR
2020/05/11 16:53:28 [INFO] generating key: rsa-2048
2020/05/11 16:53:28 [INFO] encoded CSR
2020/05/11 16:53:28 [INFO] signed certificate with serial number 217885965496432947483112196286183500766512119525
[root@hdss7-131 certs]# ll
total 16
-rw-r--r-- 1 root root  993 May 11 16:53 ca.csr
-rw-r--r-- 1 root root  326 May 11 16:49 ca-csr.json
-rw------- 1 root root 1679 May 11 16:53 ca-key.pem		#根证书的私钥
-rw-r--r-- 1 root root 1338 May 11 16:53 ca.pem			#根证书的私钥
```
+ ### 安装docker
```
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
#每台机器都安装docker
[root@hdss7-131 docker]# cat daemon.json
{
  "graph": "/data/docker",
  "storage-driver": "overlay2",
  "insecure-registries": ["registry.access.redhat.com","quay.io","harbor.od.com"],		#添加harbor.od.com字段，把仓库设置为可信任
  "registry-mirrors": ["https://q2gr04ke.mirror.aliyuncs.com"],
  "bip": "172.7.131.1/24",	#bip 取linux主机的ip后一位，方便管理
  "exec-opts": ["native.cgroupdriver=systemd"],
  "live-restore": true
}
https://github.com/goharbor/harbor  #使用harbor搭建docker私有仓库
[root@hdss7-131]# mkdir /opt/src -p
[root@hdss7-131 src]# pwd
/opt/src
[root@hdss7-131 src]# tar xvf harbor-offline-installer-v1.8.3.tgz -C/opt 
harbor/harbor.v1.8.3.tar.gz
harbor/prepare
harbor/LICENSE
harbor/install.sh
harbor/harbor.yml
[root@hdss7-131 opt]# mv harbor/ harbor-v1.8.3
[root@hdss7-131 opt]# ln -s /opt/harbor-v1.8.3/ /opt/harbor	#软连接到/opt/src下，方便以后升级
[root@hdss7-131 opt]# ll
total 0
drwxr-xr-x  2 root root  71 May 11 16:53 certs
drwx--x--x. 4 root root  28 May 11 12:06 containerd
lrwxrwxrwx  1 root root  19 May 11 17:37 harbor -> /opt/harbor-v1.8.3/
drwxr-xr-x  2 root root 100 May 11 17:36 harbor-v1.8.3
drwxr-xr-x  2 root root  49 May 11 17:34 src
[root@hdss7-131 harbor]# vim harbor.yml
hostname: harbor.od.com
   port: 180
harbor_admin_password: Harbor12345
data_volume: /data/docker
#安装docker-compose，harbor基于单机编排
yum install docker-compose -y
[root@hdss7-131 harbor]# rpm -qa docker-compose
docker-compose-1.18.0-4.el7.noarch
[root@hdss7-131 harbor]# ./install.sh
[root@hdss7-131 harbor]# yum install nginx -y  #使用nginx反代
[root@hdss7-131 harbor]# vim /etc/nginx/conf.d/harbor.od.com.conf
server {
    listen       80;
    server_name  harbor.od.com;

    client_max_body_size 1000m;

    location / {
        proxy_pass http://127.0.0.1:180;
    }
}
[root@hdss7-131 harbor]# systemctl restart nginx
hdss7-129上:
[root@hdss7-129 ~]# vi /var/named/od.com.zone
harbor             A    192.168.56.131
```
浏览器打开http://harbor.od.com
![](https://github.com/Kingserch/Job-accumulation/blob/Kubernetes/images/harbor.png)
```
[root@hdss7-131 conf.d]# docker pull nginx:1.7.9
[root@hdss7-131 conf.d]# docker tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9
[root@hdss7-131 conf.d]# docker login harbor.od.com
Username: admin
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
[root@hdss7-131 ~]# docker push harbor.od.com/public/nginx:v1.7.9
The push refers to repository [harbor.od.com/public/nginx]
5f70bf18a086: Pushed 
4b26ab29a475: Pushed 
ccb1d68e3fb7: Pushed 
e387107e2065: Pushed 
63bf84221cce: Pushed 
e02dce553481: Pushed 
dea2e4984e29: Pushed 
v1.7.9: digest: sha256:b1f5935eb2e9e2ae89c0b3e2e148c19068d91ca502e857052f14db230443e4c2 size: 3012
```
+ ### 部署master节点服务

#### 1)配置etcd证书
```
[root@hdss7-131 certs]# vim /opt/certs/ca-config.json
{
    "signing": {
        "default": {
            "expiry": "175200h"	#证书过期时间
        },
        "profiles": {
            "server": {
                "expiry": "175200h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth"
                ]
            },
            "client": {		#客户端
                "expiry": "175200h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "client auth"
                ]
            },
            "peer": {			#互相通信
                "expiry": "175200h",
                "usages": [
                    "signing",
                    "key encipherment",
                    "server auth",
                    "client auth"
                ]
            }
        }
    }
}
[root@hdss7-131 certs]# vi etcd-peer-csr.json
{
    "CN": "k8s-etcd",
    "hosts": [
        "192.168.56.128",
        "192.168.56.129",
        "192.168.56.130",
        "192.168.56.131"
    ],
    "key": {
        "algo": "rsa",
        "size": 2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ]
}
#生产etcd证书和私钥
[root@hdss7-131 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json |cfssl-json -bare etcd-peer
2020/05/12 11:19:23 [INFO] generate received request
2020/05/12 11:19:23 [INFO] received CSR
2020/05/12 11:19:23 [INFO] generating key: rsa-2048
2020/05/12 11:19:23 [INFO] encoded CSR
2020/05/12 11:19:23 [INFO] signed certificate with serial number 65897943636016508687974124617311544054963979665
2020/05/12 11:19:23 [WARNING] This certificate lacks a "hosts" field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 ("Information Requirements").
[root@hdss7-131 certs]# ll
total 36
-rw-r--r-- 1 root root  836 May 12 11:04 ca-config.json
-rw-r--r-- 1 root root  993 May 11 16:53 ca.csr
-rw-r--r-- 1 root root  326 May 11 16:49 ca-csr.json
-rw------- 1 root root 1679 May 11 16:53 ca-key.pem
-rw-r--r-- 1 root root 1338 May 11 16:53 ca.pem
-rw-r--r-- 1 root root 1062 May 12 11:19 etcd-peer.csr
-rw-r--r-- 1 root root  383 May 12 11:11 etcd-peer-csr.json
-rw------- 1 root root 1679 May 12 11:19 etcd-peer-key.pem
-rw-r--r-- 1 root root 1424 May 12 11:19 etcd-peer.pem
```
#### 2)部署etcd集群
https://github.com/etcd-io/etcd/tags
```
[root@hdss7-128 src]# useradd  -s /sbin/nologin -M etcd
[root@hdss7-128 src]# id etcd
uid=1001(etcd) gid=1001(etcd) groups=1001(etcd)
[root@hdss7-128 src]# tar xvf etcd-v3.1.20-linux-amd64.tar.gz -C /opt/ 
[root@hdss7-128 src]# cd /opt/
[root@hdss7-128 opt]# ls
containerd  etcd-v3.1.20-linux-amd64  src
[root@hdss7-128 opt]# mv etcd-v3.1.20-linux-amd64/ etcd-v3.1.20
[root@hdss7-128 opt]# ln -s /opt/etcd-v3.1.20/ /opt/etcd		#做个软连接方便以后升级
[root@hdss7-128 opt]# ll
total 0
drwx--x--x. 4 root   root   28 May 11 12:06 containerd
lrwxrwxrwx  1 root   root   18 May 12 11:41 etcd -> /opt/etcd-v3.1.20/
drwxr-xr-x  3 478493 89939 123 Oct 11  2018 etcd-v3.1.20
drwxr-xr-x  2 root   root   45 May 12 11:37 src
[root@hdss7-128 opt]# cd etcd
[root@hdss7-128 etcd]# mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server
[root@hdss7-128 etcd]# cd certs
[root@hdss7-128 certs]# ll		#把etcd的证书和私钥放在这个目录下
total 12
-rw-r--r-- 1 root root 1338 May 11 16:53 ca.pem
-rw------- 1 root root 1679 May 12 11:19 etcd-peer-key.pem	#注意私钥权限600
-rw-r--r-- 1 root root 1424 May 12 11:19 etcd-peer.pem
#启动etcd的脚本
[root@hdss7-128 etcd]# vi etcd-server-startup.sh 
#!/bin/sh
./etcd --name etcd-server-7-128 \
       --data-dir /data/etcd/etcd-server \
       --listen-peer-urls https://192.168.56.128:2380 \
       --listen-client-urls https://192.168.56.128:2379,http://1287.0.0.1:2379 \
       --quota-backend-bytes 8000000000 \
       --initial-advertise-peer-urls https://192.168.56.128:2380 \
       --advertise-client-urls https://192.168.56.128:2379,http://1287.0.0.1:2379 \
       --initial-cluster  etcd-server-7-128=https://192.168.56.128:2380,etcd-server-7-129=https://192.168.56.129:2380,etcd-server-7-130=https://192.168.56.130:2380 \
       --ca-file ./certs/ca.pem \
       --cert-file ./certs/etcd-peer.pem \
       --key-file ./certs/etcd-peer-key.pem \
       --client-cert-auth  \
       --trusted-ca-file ./certs/ca.pem \
       --peer-ca-file ./certs/ca.pem \
       --peer-cert-file ./certs/etcd-peer.pem \
       --peer-key-file ./certs/etcd-peer-key.pem \
       --peer-client-cert-auth \
       --peer-trusted-ca-file ./certs/ca.pem \
       --log-output stdout
[root@hdss7-128 etcd]# chmod +x etcd-server-startup.sh 
#更改属主
[root@hdss7-128 etcd]# chown -R etcd:etcd /opt/etcd-v3.1.20/
[root@hdss7-128 etcd]# chown -R etcd:etcd /data/etcd/
[root@hdss7-128 etcd]# chown -R etcd:etcd /data/logs/etcd-server/
#安装管理后台进程的软件
yum install supervisor -y
systemctl start supervisord 
systemctl enable supervisord


```