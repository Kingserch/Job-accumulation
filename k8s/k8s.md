+ ### Kubernetes
    + [环境准备](#环境准备)
    + [安装bind服务](#安装bind服务)
    + [配置证书](#配置证书)
    + [安装docker](#安装docker)
+ ### 环境准备
`yum install epel-release`   
`yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y`  
+ ### 安装bind服务
##### 1)在hdss7-129主机上安装bind服务(DNS服务)
```
[root@hdss7-129 ~]# yum install bind -y
[root@hdss7-129 ~]# rpm -qa bind
bind-9.11.4-16.P2.el7_8.2.x86_64
[root@hdss7-129 ~]# netstat   -rn   #查看网关
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         192.168.56.2    0.0.0.0         UG        0 0          0 ens33
172.7.68.0      0.0.0.0         255.255.255.0   U         0 0          0 docker0
192.168.56.0    0.0.0.0         255.255.255.0   U         0 0          0 ens33
[root@hdss7-129 ~]# vi /etc/named.conf
options {
        listen-on port 53 { 192.168.56.129; };	#默认是127.0.0.1本机需要改成本机的内网ip
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { any; };
        forwarders      { 0.0.0.0; };	#本机的网关
        recursion yes;	#一定要是yes 表示用递归的算法查询DNS，另一种是迭代
        dnssec-enable no;
        dnssec-validation no;
[root@hdss7-129 /]# named-checkconf	#检查
```
##### 2)在hdss7-129主机配置区域配置文件
```
[root@hdss7-129 /]# vim /etc/named.rfc1912.zones
...#在最后添加下面字段
zone "host.com" IN {
        type  master;
        file  "host.com.zone";
        allow-update { 192.168.56.129; };
};

zone "od.com" IN {
        type  master;
        file  "od.com.zone";
        allow-update { 192.168.56.129; };
};
```
##### 3)在hdss7-129主机编辑区域数据文件
```
[root@hdss7-129 /]# vim /var/named/host.com.zone
$ORIGIN host.com.
$TTL 600	; 10 minutes
@       IN SOA	dns.host.com. dnsadmin.host.com. (
				2020051101 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
			NS   dns.host.com.
$TTL 60	; 1 minute
dns                A    192.168.56.129
hdss7-11           A    192.168.56.129
hdss7-12           A    192.168.56.128
hdss7-21           A    192.168.56.130
hdss7-22           A    192.168.56.131
[root@hdss7-129 /]# vim /var/named/od.com.zone	业务域
$ORIGIN od.com.
$TTL 600	; 10 minutes
@   		IN SOA	dns.od.com. dnsadmin.od.com. (
				2020051101 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
				NS   dns.od.com.
$TTL 60	; 1 minute
dns                A    192.168.56.129
[root@hdss7-129 /]# named-checkconf		#检查更改的配置文件
[root@hdss7-129 /]# systemctl start named	
[root@hdss7-129 /]# netstat -luntp |grep 53 
tcp        0      0 192.168.56.129:53       0.0.0.0:*               LISTEN      18812/named         
tcp        0      0 127.0.0.1:953           0.0.0.0:*               LISTEN      18812/named         
tcp6       0      0 ::1:953                 :::*                    LISTEN      18812/named         
udp        0      0 192.168.56.129:53       0.0.0.0:*                           18812/named   
[root@hdss7-129 ~]# dig -t A hdss7-11.host.com @192.168.56.129 +short
192.168.56.129
[root@hdss7-129 ~]# dig -t A hdss7-12.host.com @192.168.56.129 +short
192.168.56.128
[root@hdss7-129 ~]# dig -t A hdss7-21.host.com @192.168.56.129 +short
192.168.56.130
[root@hdss7-129 ~]# dig -t A hdss7-22.host.com @192.168.56.129 +short
192.168.56.13
[root@hdss7-129 ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
search localdomain
nameserver 192.168.56.2
nameserver 192.168.56.129
```
+ ### 配置证书
```
[root@hdss7-131 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl
[root@hdss7-131 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json
[root@hdss7-131 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo
[root@hdss7-131 ~]# chmod +x /usr/bin/cfssl*
[root@hdss7-131 ~]# which cfssl
/usr/bin/cfssl
[root@hdss7-131 ~]# which cfssl-json
/usr/bin/cfssl-json
[root@hdss7-131 ~]# which cfssl-certinfo
/usr/bin/cfssl-certinfo
[root@hdss7-131 ~]# mkdir -p /opt/certs
[root@hdss7-131 ~]# cd /opt/certs/
[root@hdss7-131 certs]# pwd
/opt/certs
[root@hdss7-131 certs]# vi ca-csr.json
{
    "CN": "kingEdu",
    "hosts": [
    ],
    "key": {
        "algo": "rsa",	#rsa加密算法
        "size": 2048	#长度2048
    },
    "names": [
        {
            "C": "CN",
            "ST": "beijing",
            "L": "beijing",
            "O": "od",
            "OU": "ops"
        }
    ],
    "ca": {
        "expiry": "175200h"		#证书过期时间
    }
}
[root@hdss7-131 certs]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca
2020/05/11 16:53:28 [INFO] generating a new CA key and certificate from CSR
2020/05/11 16:53:28 [INFO] generate received request
2020/05/11 16:53:28 [INFO] received CSR
2020/05/11 16:53:28 [INFO] generating key: rsa-2048
2020/05/11 16:53:28 [INFO] encoded CSR
2020/05/11 16:53:28 [INFO] signed certificate with serial number 217885965496432947483112196286183500766512119525
[root@hdss7-131 certs]# ll
total 16
-rw-r--r-- 1 root root  993 May 11 16:53 ca.csr
-rw-r--r-- 1 root root  326 May 11 16:49 ca-csr.json
-rw------- 1 root root 1679 May 11 16:53 ca-key.pem		#根证书的私钥
-rw-r--r-- 1 root root 1338 May 11 16:53 ca.pem			#根证书的私钥
```
+ ### 安装docker
```
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
#每台机器都安装docker
[root@hdss7-131 docker]# cat daemon.json
{
  "graph": "/data/docker",
  "storage-driver": "overlay2",
  "insecure-registries": ["registry.access.redhat.com","quay.io"],
  "registry-mirrors": ["https://q2gr04ke.mirror.aliyuncs.com"],
  "bip": "172.7.131.1/24",	#bip 取linux主机的ip后一位，方便管理
  "exec-opts": ["native.cgroupdriver=systemd"],
  "live-restore": true
}
https://github.com/goharbor/harbor  #使用harbor搭建docker私有仓库
[root@hdss7-131]# mkdir /opt/src -p
[root@hdss7-131 src]# pwd
/opt/src
[root@hdss7-131 src]# tar xvf harbor-offline-installer-v1.8.3.tgz -C/opt 
harbor/harbor.v1.8.3.tar.gz
harbor/prepare
harbor/LICENSE
harbor/install.sh
harbor/harbor.yml
[root@hdss7-131 opt]# mv harbor/ harbor-v1.8.3
[root@hdss7-131 opt]# ln -s /opt/harbor-v1.8.3/ /opt/harbor	#软连接到/opt/src下，方便以后升级
[root@hdss7-131 opt]# ll
total 0
drwxr-xr-x  2 root root  71 May 11 16:53 certs
drwx--x--x. 4 root root  28 May 11 12:06 containerd
lrwxrwxrwx  1 root root  19 May 11 17:37 harbor -> /opt/harbor-v1.8.3/
drwxr-xr-x  2 root root 100 May 11 17:36 harbor-v1.8.3
drwxr-xr-x  2 root root  49 May 11 17:34 src
[root@hdss7-131 harbor]# vim harbor.yml
hostname: harbor.od.com
   port: 180
harbor_admin_password: Harbor12345
data_volume: /data/docker
#安装docker-compose，harbor基于单机编排
yum install docker-compose -y
[root@hdss7-131 harbor]# rpm -qa docker-compose
docker-compose-1.18.0-4.el7.noarch
[root@hdss7-131 harbor]# ./install.sh
[root@hdss7-131 harbor]# yum install nginx -y  #使用nginx反代
[root@hdss7-131 harbor]# vim /etc/nginx/conf.d/harbor.od.com.conf
server {
    listen       80;
    server_name  harbor.od.com;

    client_max_body_size 1000m;

    location / {
        proxy_pass http://127.0.0.1:180;
    }
}
[root@hdss7-131 harbor]# systemctl restart nginx
在配置的DNS中
```