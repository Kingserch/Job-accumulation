+ ### 配置私有仓库 
    + [仓库](#仓库)
    + [配置registry](#配置文件管理私有仓库)
    + [坑位](#坑位)
    + [坑位](#坑位)
+ ### 仓库
##### 1.安装Dcoker Registry,基于容器安装  
`docker run -d -p 5000:5000 --restart=always --name registry registry:2`  
##### 2.本地安装运行
```
yum install -y epel-release	
yum install golang -y
go version
go version go1.13.3 linux/amd64
mkdir -p $GOPATH/src/github.com/docker/	
cd $GOPATH/src/github.com/docker/
git clone https://github.com/docker/distribution.git	
```
##### 3.配置TLS证书
```
[root@m129 ~]# docker tag centos:7 registry:5000/centos:7	#本地的centos镜像上传到仓库
[root@m129 ~]# docker push registry:5000/centos:7	#推到仓库
[root@m129 ~]# mkdir -p /root/certs	#创建存放TLS证书的目录
[root@m129 ~]# openssl req -newkey rsa:4096 -nodes -sha256 -keyout /root/certs/repo.key -x509 -days 365 -out /root/certs/repo.crt
Generating a 4096 bit RSA private key
...................................++
.....................................................................................................................++
writing new private key to 'certs/repo.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:ki	#国家名称
State or Province Name (full name) []:henan	#省
Locality Name (eg, city) [Default City]:zz	#地区城市
Organization Name (eg, company) [Default Company Ltd]:sj	#公司
Organizational Unit Name (eg, section) []:yw	#职位
Common Name (eg, your name or your server's hostname) []:192.168.10.129	#服务器名称或者ip
Email Address []:2249155086@qq.com	#邮箱
[root@m129 ~]# cd certs/
[root@m129 certs]# ls
repo.crt  repo.key	#秘钥文件repo.key，证书文件repo.crt，这个文件是需要发给用户，配置到用户docker hosts上，
[root@m129 certs]# docker run -d --restart=always --name registry -v 'pwd'/certs:/certs -e REGISTRY_HTTP_ADDR=0.0.0.0:443 -e REGISTRY_HTTP_TLS_CERTIFICATE=/root/certs/repo.crt -e REGISTRY_HTTP_TLS_KEY=/root/certs/repo.key -p 443:443
#上命令是启动证书
```
##### 4.管理访问权限
具体交互过程包括如下步骤：
* Docker Daemon或者其他客户端尝试访问Registry服务器，比如pull、push或者访问manifiest文件；
* 在Registry服务器开启了认证服务模式时，就会直接返回401 Unauthorized错误，并通知调用方如何获得授权；
* 调用方按照要求，向Authorization Service发送请求，并携带Authorization Service需要的信息，比如用户名、密码；
* 如果授权成功，则可以拿到合法的Bearer token，来标识该请求方可以获得的权限；
* 请求方将拿到Bearer token加到请求的Authorization header中，再次尝试步骤1中的请求；
* Registry服务通过验证Bearer token以及JWT格式的授权数据，来决定用户是否有权限进行请求的操作。
配置nginx代理
```
sudo rpm -Uvh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm	
sudo yum install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
##Add		#开放80端口
firewall-cmd --permanent --zone=public --add-port=80/tcp
##Reload
firewall-cmd --reload
[root@m129 default.d]# vim /etc/nginx/default.d/default.conf 在default.conf文件中添加代理配置
# 本地的registry服务监听在5000端口
upstream docker-registry {
server localhost:5000;
}

# 本地的registry服务监听在5000端口
upstream docker-registry {
	server localhost:5000;
   }

#代理服务器监听在5000端口
server {
    listen 5000;
    server_name private-registry-server.com;
    add_header 'Docker-Distribution-Api-Version' 'registry/2.0' always;
# If you have SSL certification files, then can enable this section.
    ssl on;
    ssl_certificate /etc/nginx/ssl/repo.crt;
    ssl_certificate_key /etc/nginx/ssl/repo.key;
    proxy_pass                        http://docker-registry;
    proxy_set_header   Host           \$http_host;     #  required  for  docker
    client's sake
    proxy_set_header  X-Real-IP           \$remote_addr; # pass on real client's IP
    proxy_set_header   X-Forwarded-For    \$proxy_add_x_forwarded_for;
    proxy_set_header   X-Forwarded-Proto \$scheme;
    proxy_read_timeout                       600;

    client_max_body_size  0;  #  disable  any  limits  to  avoid  HTTP  413  for  large
            image uploads
# required to avoid HTTP 411: see Issue #1486(https://github.com/dotcloud/docker/issues/1486)
    chunked_transfer_encoding on;

    location /v2/ {
        # 禁止旧版本 Docker 访问
        if (\$http_user_agent ~ "^(docker\/1\.(3|4|5(? ! \.[0-9]-dev))|Go ).＊\$" ) {
            return 404;
             }
		# 配置转发访问请求到registry服务
		proxy_pass http://docker-registry;
	    }
	}
[root@m129 /]# docker tag centos:7 127.0.0.1:5000/centos:7
root@m129 /]# docker push 127.0.0.1:5000/centos:7
The push refers to repository [127.0.0.1:5000/centos]	#可以看到已经存在了
77b174a6a187: Layer already exists 
7: digest: sha256:285bc3161133ec01d8ca8680cd746eecbfdbc1faa6313bd863151c4b26d7e5a5 size: 529
[root@m129 /]#
```
##### 5.添加用户认证  
公共仓库DockerHub是通过注册索引服务来实现的，但并不完善，所以用nginx代理的用户访问管理方案，Nginx支持基于用户名和密码的访问管理
```
[root@m129 default.d]# vim default.conf 
	....
        location / {
            # 这里改动了 定义首页索引文件的名称
            index index.php index.jsp index.html index.htm;
            # let Nginx know about our auth file	#新加的内容
            auth_basic                  "Please Input username/password";	#启动认证服务，不通过请求无法转发
            auth_basic_user_file     docker-registry-htpasswd;	#指定验证用户名密码的存储文件为本地/etc/nginx/下的docker-registry-htpasswdwd文件
			proxy_pass http://docker-registry;
        }
	...
[root@m129 default.d]# systemctl restart nginx
[root@m129 nginx]# touch docker-registry-htpasswdwd
[root@m129 nginx]# vim docker-registry-htpasswdwd 	#密码字段存储不是明文的，是使用crypt函数加密过的字符串，用htpasswd工具。
#用户名:密码
kingserch:qax123123
 ```
+ ### 配置文件管理私有仓库



		

