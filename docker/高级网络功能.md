+ ### 高级网络功能 
    + [安全和防护](#安全和防护)
    + [高级网络功能](#高级网络功能)
    + [配置容器DNS和主机名](#配置容器DNS和主机名)
    + [容器访问控制](#容器访问控制)
	+ [配置容器网桥](#配置容器网桥)
	+ [libnetwork插件化网络功能](#libnetwork插件化网络功能)
+ ### 安全和防护
[Docker Bench](https://github.com/docker/docker-bench-secu-rity)
```
git clone https://github.com/docker/docker-bench-security.git
cd docker-bench-security/
docker-compose run --rm docker-bench-security
```
+ ### 高级网络功能
##### 1.docker容器与主机是如何通信的
Docker服务启动时首先在主机上自动创建一个docker0虚拟网桥(实际上是一个Linux网桥)，同时Docker随机分配一个本地未占用的私有网段，当创建一个docker容器的时候，同时会创建一对veth pair互联接口，当向任一个接口发送包时，另外一个接口自动收到相同的包，互联接口的一端位于容器内，即erh0，另一端在本地被挂载到docker0网桥，名称以veth开头，这样就实现了通信
##### 2.网络相关参数
```
-b BRIDGE or --bridge=BRIDGE：指定容器挂载的网桥；
--bip=CIDR：定制docker0的掩码；
-H SOCKET... or --host=SOCKET...:Docker服务端接收命令的通道；
--icc=true|false：是否支持容器之间进行通信；
--ip-forward=true|false：启用net.ipv4.ip_forward，即打开转发功能；
--iptables=true|false：禁止Docker添加iptables规则；
--mtu=BYTES：容器网络中的MTU。
# 下面的命令选项既可以在启动服务时指定，也可以Docker容器启动（使用docker[con-tainer] run命令）时候指定。在Docker服务启动的时候指定则会成为默认值，后续执行该命令时可以覆盖设置的默认值：
--dns=IP_ADDRESS：使用指定的DNS服务器；
--dns-opt=""：指定DNS选项；
--dns-search=DOMAIN：指定DNS搜索域。
# 还有些选项只能在docker [container] run命令执行时使用，因为它针对容器的配置：
-h HOSTNAME or --hostname=HOSTNAME：配置容器主机名；
-ip=""：指定容器内接口的IP地址；
--link=CONTAINER_NAME:ALIAS：添加到另一个容器的连接；
--net=bridge|none|container:NAME_or_ID|host|user_defined_network：配置容器的桥接模式；
--network-alias：容器在网络中的别名；
-p SPEC or --publish=SPEC：映射容器端口到宿主主机；
-P or --publish-all=true|false：映射容器所有端口到宿主主机。
# 其中，--net选项支持以下五种模式：
--net=bridge：默认配置。为容器创建独立的网络命名空间，分配网卡、IP地址等网络配置，并通过veth接口对将容器挂载到一个虚拟网桥（默认为docker0）上；
--net=none：为容器创建独立的网络命名空间，但不进行网络配置，即容器内没有创建网卡、IP地址等；
--net=container:NAME_or_ID：新创建的容器共享指定的已存在容器的网络命名空间，两个容器内的网络配置共享，但其他资源（如进程空间、文件系统等）还是相互隔离的；
--net=host：不为容器创建独立的网络命名空间，容器内看到的网络配置（网卡信息、路由表、Iptables规则等）均与主机上的保持一致。注意其他资源还是与主机隔离的；
--net=user_defined_network：用户自行用network相关命令创建一个网络，同一个网络内的容器彼此可见，可以采用更多类型的网络插件。
```
+ ### 配置容器DNS和主机名
Docker服务启动后会默认启用一个内嵌的DNS服务，用来自动解析用一个网络中的容器主机名和地址。容器中主机和DNS的配置信息可以通过三个系统配置文件管理/etc/resolv.conf,/etchostname,/etc/hosts。
##### 1.相关的配置文件
```
[root@m115 ~]# docker run -it centos:7	#启动一个镜像
Unable to find image 'centos:7' locally
7: Pulling from library/centos
ab5ef0e58194: Pull complete 
Digest: sha256:4a701376d03f6b39b8c2a8f4a8e499441b0d567f9ab9d58e4991de4472fb813c
Status: Downloaded newer image for centos:7
[root@9efa178813c1 /]# mount	#看三个文件的挂载信息,docker容器启动时，会从宿主机上复制/etc/resolv.conf文件，并删除其中无法连接到的DNS服务器
...	
/dev/mapper/centos-root on /etc/resolv.conf type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/hostname type xfs (rw,relatime,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/hosts type xfs (rw,relatime,attr2,inode64,noquota)
...
[root@9efa178813c1 /]# cat /etc/resolv.conf 
# Generated by NetworkManager
nameserver 114.114.114.114
[root@9efa178813c1 /]# cat /etc/hosts	#该文件默认只记录了容器自身的地址和名称
127.0.0.1	localhost
::1	localhost ip6-localhost ip6-loopback
fe00::0	ip6-localnet
ff00::0	ip6-mcastprefix
ff02::1	ip6-allnodes
ff02::2	ip6-allrouters
172.17.0.2	9efa178813c1
[root@9efa178813c1 /]# cat /etc/hostname	#该文件只记录了容器的名称
9efa178813c1
```
##### 2.容器内修改配置文件
容器运行时，可以在运行中的容器里直接编辑三个文件，但这些修改只是临时的，只在运行的容器中保留，容器终止或者重启后并不会被保存下来，也不会被docker commit提交。
##### 3.通过参数指定
要自定义容器的配置，可以在创建或启动容器时利用下面的参数指定，注意一般不推荐与-net=host一起使用，会破坏宿主机上的配置信息：
```
指定主机名-h HOSTNAME或者--hostname=HOSTNAME：设定容器的主机名。容器主机名会被写到容器内的/etc/hostname和/etc/hosts。但这个主机名只有容器内能中看到，在容器外部看不到，docker ps 不显示，其他容器的/etc/hosts看不到。
--link=CONTAINER_NAME:ALIAS：记录其他容器主机名。在创建容器的时候，添加一个所连接容器的主机名到容器内/etc/hosts文件中。这样，新建容器可以直接使用主机名与所连接容器通信；
--dns=IP_ADDRESS：指定DNS服务器。添加DNS服务器到容器的/etc/resolv. conf中，容器会用指定的服务器来解析所有不在/etc/hosts中的主机名；
--dns-option list：指定DNS相关的选项；
--dns-search=DOMAIN：指定DNS搜索域。设定容器的搜索域，当设定搜索域为．example.com时，在搜索一个名为host的主机时，DNS不仅搜索host，还会搜索host.example.com
```
+ ### 容器访问控制
容器的访问控制主要是通过Linux上的iptables防火墙软件来进行管理和实现
##### 1.容器访问外部网络
容器默认指定了网关为docker0网桥上的docker0内部接口，docker内部接口同时也是宿主机的一个本地接口，容器默认情况下可以访问到宿主机本地网络，如果容器想要通过宿主机访问到外部网络，则需要宿主机进行辅助转发。
```
[root@m115 ~]# sysctl net.ipv4.ip_forward	#在宿主机上检查转发是否打开，0则是没打开，sysctl -w net.ipv4.ip_forward = 1 手动打开
net.ipv4.ip_forward = 1		#docker服务启动时，会默认开启--ip-forward=true，自动配置宿主机的转发规则
```
+ ### 配置容器网桥
Docker服务默认会创建一个名称为docker0的Linux网桥(其上有一个docker0内部接口)，他在内核层连通了其他的物理或虚拟网卡，这就将所有容器和本地主机都放在了一个物理网络，用户使用docker创建多个自定义网络时可能会出现多个容器网桥
```
yum install bridge-utils	#可以在配置文件中配置DOCKER_OPTS,然后重启服务，目前是Docker网桥是linux网桥，可以用brctl show 查看
brctl show
```
##### 1.自定义网桥
用户不想用docker0网桥，可以在启动docker服务的时候，使用-b BRIDGE或--bridge=BRIDGE来指定使用的网桥。
```
#1.如果服务已经运行，需要停止，并删除旧的网桥
systemctl stop docker
ip link set dev docker0 down
brctl delbr docker0
#2.创建一个网桥bridge0
brctl addbr bridge0
ip addr add  192.168.161.130/24 dev bridge0
ip link set dev bridge0 up
#3.查看确认网桥有没有启动
addr show bridge0
#4.配置docker服务，默认桥接创建的网桥上。
echo 'DOCKER_OPTS="-b=bridge0"' >>/etc/default/docker
systemctl start docker 
可以用brctl show 命令查看网桥信息，在容器中也可以使用ip addr和ip route命令来查看ip地址配置和路由信息
```
##### 2.使用OpenSwitch网桥
```
[root@m129 ~]# brctl show	#查看网桥信息
bridge name	bridge id		STP enabled	interfaces
docker0		8000.02425daa76ca	no		
[root@m129 ~]# ifconfig docker0	#网桥内部接口默认地址为172.17.0.1
docker0: flags=4099<UP,BROADCAST,MULTICAST>  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 172.17.255.255
        ether 02:42:5d:aa:76:ca  txqueuelen 0  (Ethernet)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```
+ ### libnetwork插件化网络功能
容器网络模型包括扩三种基本元素
❑ 沙盒（Sandbox）：代表一个容器（准确地说，是其网络命名空间）；
❑ 接入点（Endpoint）：代表网络上可以挂载容器的接口，会分配IP地址；
❑ 网络（Network）：可以连通多个接入点的一个子网。
首先，驱动注册自己到网络控制器，网络控制器使用驱动类型，来创建网络，然后在创建的网络上创建接口，最后把容器连接到接口上即可，销毁过程则正好相反，先把容器从接口上卸载，然后删除接入口和网络即可。CNM的生命周期图如下:
![CNM的生命周期图]()